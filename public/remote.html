<!DOCTYPE html>
<html>
    <head>
        <title>A3-Mobile</title>
        <script src="js/aframe-v0.8.2.min.js"></script>
        <script src="js/socket.io.min.js"></script>
        <script>
            AFRAME.registerComponent('editable', {
                schema: {
                    id: {default: 'entity'},
                },

                init: function()
                {
                    let el = this.el;
                    el.addEventListener('mousedown', this.ondragStart);
                    el.addEventListener('mouseup', this.ondragEnd);

                    //this.soundElem = document.querySelector('#canSound');
                    this.ondragStart = this.ondragStart.bind(this);
                    this.ondragEnd = this.ondragEnd.bind(this);
                    this.scale = this.scale.bind(this);
                    this.getPos = this.getPos.bind(this);

                    //this.followMouse = this.followMouse.bind(this);
                    //this.createMe = this.createMe.bind(this);
                },
                
                ondragStart: function(evt)
                {
                    let el = evt.target;
                    el.setAttribute('geometry', 'height', '0');
                    console.log(el);
                    this.components['editable'].scale();
                },
                ondragEnd: function(evt)
                {
                    this.components['editable'].stop();
                },
                scale: function(){
                    this.el.sceneEl.canvas.addEventListener('mousemove', this.getPos);  
                },
                stop: function(){
                    this.el.sceneEl.canvas.removeEventListener('mousemove', this.getPos);  
                },
                getPos: function(e){
                    
                    let h_size =  e.pageX / 100;
                    this.el.setAttribute('geometry', 'height', h_size);
                }
            });
        </script>
    </head>
   
    <body>
        <script>
            function onSceneLoad(){
                let socket = io();
                var currObj = {id:"box", height: 0};
                let wrapper = document.querySelector('#workspace');
                let scene = document.querySelector('a-scene');
                document.querySelector('#box_Init').addEventListener('click', createEl);
                document.querySelector('#sphere_Init').addEventListener('click', createEl);
                document.querySelector('#cylinder_Init').addEventListener('click', createEl);
                document.querySelector('#send_button').addEventListener('click', function(e)
                {
                    obj = wrapper.querySelector('#'+currObj.id);
                    currObj.height = obj.height;
                    socket.emit('newShape', currObj);
                    wrapper.removeChild(obj);
                });
                
                
                //default connect event
                socket.on('connect', function() {
                    console.log("connected!");
                });
        
                socket.on('requestSmall', function(data) {
                    console.log('Small boi');
                });

                socket.on('requestMed', function(data) {
                    console.log('Med boi');
                });
                socket.on('requestBig', function(data) {
                    console.log('Big boi');
                });
                socket.on('recreate', function(data) {
                    for(i in data)
                    {
                        createEl(data[i]);
                    }
                    
                });

                function createEl(e){
                    console.log('Creating new shape', e);
                    let newEl = document.createElement('a-entity');
                    newEl.setAttribute("geometry", {primitive: e.srcElement.components.geometry.attrValue.primitive});
                    let pos = e.detail.cursorEl.attributes.position.value;
                    newEl.object3D.position.set(pos[0], pos[1]-1,pos[2]);

                    newEl.setAttribute('id', e.srcElement.components.geometry.attrValue.primitive);
                    console.log(newEl);
                    //currObj.id = newEl.id;

                    newEl.setAttribute('editable', '');
                    wrapper.appendChild(newEl);
                };
              

        };
        </script>

        <a-scene>
            <!---------------- CAMERA ---------------->
            <a-entity id="cameraRig" position="" rotation="0 0 0">
                <a-entity camera id="sceneCamera" position="0 5 0"
                            look-controls-enabled='false'>
                    <a-entity id="cursor" 
                            cursor="rayOrigin: mouse" 
                            position="0 0 -1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <!---------------- A-FRAME ENTITIES ---------------->

            <a-box id="box_Init" position="5 7 -6"></a-box>
            <a-sphere id="sphere_Init" position="5 4.5 -6"></a-sphere>
            <a-cylinder id="cylinder_Init" position="5 2 -6"></a-cylinder>
            
            <a-entity id="workspace" position="0 4 -3"></a-entity>
            <a-plane id="send_button" position="-6 7 -6" width="3" height="2" rotation="0 15 0" material="src:#small_tex;" shadow></a-plane> 


            <!-- GROUND & SKY -->
            <a-plane static-body id="ground" position="0 0 5" width="30" height="30" rotation="-90 0 0" color="#a5a5a5" shadow></a-plane> 
                                
            <a-sky color="#bfd7ff" ></a-sky>
        </a-scene>



        <script>
                document.querySelector('a-scene').addEventListener('loaded', onSceneLoad);
               
        </script>
    </body> 
</html>